<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chess Mimic - Professional Practice</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <style>
        .active-tab {
            border-bottom: 2px solid #3b82f6;
            color: #3b82f6;
        }

        .highlight-player {
            color: #3b82f6;
            font-weight: bold;
        }

        #board-container {
            position: relative;
        }

        #arrow-svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 100;
        }

        #eval-bar-v {
            width: 30px;
            flex-shrink: 0;
            background: #374151;
            border-radius: 2px;
            overflow: visible;
            display: flex;
            flex-direction: column-reverse;
            position: relative;
        }

        #eval-white-v {
            background: white;
            width: 100%;
            transition: height 0.5s ease;
        }

        #eval-num {
            position: absolute;
            width: 100%;
            text-align: center;
            font-size: 11px;
            font-weight: bold;
            color: #ff00ff;
            z-index: 50;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
            text-shadow: 1px 1px 1px black;
        }

        .move-btn {
            background: #374151;
            border: 1px solid transparent;
            flex: 1;
            min-width: 45%;
            max-width: 48%;
        }

        .move-btn.active {
            border-color: #3b82f6;
            background: #1e3a8a !important;
            font-weight: bold;
        }

        .comment-display {
            width: 100%;
            font-size: 10px;
            color: #fbbf24;
            padding: 4px 8px;
            background: #1f2937;
            border-radius: 4px;
            margin: 4px 0 8px 0;
            border-left: 2px solid #fbbf24;
        }

        .comment-indicator {
            color: #fbbf24;
            margin-left: 2px;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 34px;
            height: 20px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #4b5563;
            transition: .4s;
            border-radius: 20px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 14px;
            width: 14px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked+.slider {
            background-color: #3b82f6;
        }

        input:checked+.slider:before {
            transform: translateX(14px);
        }
    </style>
</head>

<body class="bg-gray-900 text-white font-sans md:overflow-hidden">
    <div class="flex flex-col min-h-screen md:h-screen">
        <header class="bg-gray-800 px-3 py-2 border-b border-gray-700 flex flex-col md:flex-row justify-between items-center h-auto md:h-16 overflow-hidden flex-shrink-0">
            <h1 class="text-lg font-bold text-blue-400">♟️ Chess Mimic</h1>
            <div class="flex flex-wrap items-center justify-center gap-3">
                <div class="flex items-center space-x-2">
                    <span class="text-[10px] text-gray-500 uppercase font-bold">Engine</span>
                    <label class="switch">
                        <input type="checkbox" id="engine-toggle" checked onchange="toggleEngine()">
                        <span class="slider"></span>
                    </label>
                </div>
                <div id="engine-status" class="text-[10px] text-gray-500 font-mono w-24 text-center truncate">Engine: Idle</div>
                <input type="text" id="player-filter" placeholder="Filter..."
                    class="bg-gray-700 border border-gray-600 rounded px-2 py-0.5 text-xs focus:outline-none w-20 md:w-auto">
                <input type="file" id="pgn-upload" class="hidden">
                <button onclick="$('#pgn-upload').click()"
                    class="bg-blue-600 hover:bg-blue-500 px-3 py-0.5 rounded text-xs font-medium">Upload</button>
            </div>
        </header>

        <main class="flex flex-col md:flex-row flex-1 overflow-y-auto md:overflow-hidden">
            <div class="w-full md:w-2/3 p-4 md:p-6 flex items-center justify-center bg-gray-850">
                <div id="board-container" class="relative w-full max-w-[800px] flex space-x-2 h-fit items-start">
                    <div id="eval-bar-v" class="border border-gray-700">
                        <div id="eval-num">0.0</div>
                        <div id="eval-white-v" style="height: 50%"></div>
                    </div>
                    <div class="relative flex-1">
                        <div id="myBoard" class="w-full"></div>
                        <svg id="arrow-svg"></svg>
                    </div>
                </div>
            </div>

            <div class="w-full md:w-1/3 bg-gray-800 border-t md:border-t-0 md:border-l border-gray-700 flex flex-col min-h-[400px] md:min-h-0">
                <div class="flex border-b border-gray-700 text-center">
                    <button onclick="showTab('tree')" id="tab-tree"
                        class="flex-1 py-3 text-xs font-medium active-tab uppercase">Tree</button>
                    <button onclick="showTab('games')" id="tab-games"
                        class="flex-1 py-3 text-xs font-medium text-gray-400 uppercase">Games</button>
                    <button onclick="showTab('moves')" id="tab-moves"
                        class="flex-1 py-3 text-xs font-medium text-gray-400 uppercase">Moves</button>
                    <button onclick="showTab('puzzles')" id="tab-puzzles"
                        class="flex-1 py-3 text-xs font-medium text-gray-400 uppercase">Puzzles</button>
                    <button onclick="showTab('analysis')" id="tab-analysis"
                        class="flex-1 py-3 text-xs font-medium text-gray-400 uppercase">Engine</button>
                </div>

                <div class="flex-1 overflow-y-auto p-4">
                    <div id="content-tree" class="tab-content">
                        <table class="w-full text-left text-sm">
                            <thead class="text-gray-500 border-b border-gray-700">
                                <tr>
                                    <th class="pb-2">Move</th>
                                    <th class="pb-2">Count</th>
                                    <th class="pb-2">Win %</th>
                                    <th class="pb-2 text-right">Result</th>
                                </tr>
                            </thead>
                            <tbody id="tree-body"></tbody>
                        </table>
                    </div>
                    <div id="content-games" class="tab-content hidden">
                        <div id="game-list" class="space-y-2"></div>
                    </div>
                    <div id="content-moves" class="tab-content hidden flex flex-col h-full">
                        <div id="active-game-header" class="mb-4 pb-2 border-b border-gray-700 hidden">
                            <div class="font-bold text-blue-400 text-sm" id="ag-players"></div>
                            <div class="text-[10px] text-gray-400" id="ag-meta"></div>
                        </div>
                        <div id="move-list" class="flex flex-wrap gap-1 mb-4">
                            <div class="text-gray-500 text-xs italic text-center w-full">Select a game...</div>
                        </div>
                        <div id="annotation-box" class="mt-auto border-t border-gray-700 pt-4 hidden">
                            <label class="block text-[10px] font-bold text-gray-500 uppercase mb-2">Move
                                Annotation</label>
                            <textarea id="comment-input"
                                class="w-full bg-gray-900 border border-gray-700 rounded p-2 text-sm text-gray-300 focus:outline-none focus:border-blue-500"
                                rows="3" placeholder="Add notes..."></textarea>
                            <div class="flex justify-end mt-2">
                                <button onclick="saveAnnotation()"
                                    class="bg-blue-600 hover:bg-blue-500 px-3 py-1 rounded text-xs font-medium">Save
                                    Note</button>
                            </div>
                        </div>
                    </div>
                    <div id="content-puzzles" class="tab-content hidden">
                        <button onclick="findPuzzles()"
                            class="w-full bg-blue-600 hover:bg-blue-500 text-white py-2 rounded text-xs font-bold mb-4">Scan
                            for Blunders</button>
                        <div id="puzzle-list" class="space-y-2"></div>
                    </div>
                    <div id="content-analysis" class="tab-content hidden">
                        <div id="engine-lines" class="space-y-3"></div>
                    </div>
                </div>
                <div class="p-4 border-t border-gray-700 bg-gray-850 flex justify-between items-center flex-shrink-0">
                    <div class="flex space-x-1">
                        <button id="btn-start"
                            class="bg-gray-700 hover:bg-gray-600 px-3 py-1 rounded text-sm">|&lt;</button>
                        <button id="btn-prev"
                            class="bg-gray-700 hover:bg-gray-600 px-3 py-1 rounded text-sm">&lt;</button>
                        <button id="btn-next"
                            class="bg-gray-700 hover:bg-gray-600 px-3 py-1 rounded text-sm">&gt;</button>
                        <button id="btn-end"
                            class="bg-gray-700 hover:bg-gray-600 px-3 py-1 rounded text-sm">&gt;|</button>
                    </div>
                    <div id="eval-text" class="font-mono text-sm text-gray-400">0.0</div>
                </div>
            </div>
        </main>
    </div>

    <script>
        let board = null;
        let game = new Chess();
        let treeData = {};
        let selectedGameId = null;
        let currentMoveIndex = -1; // -1 is start position
        let gameMoves = [];
        const ARROW_COLOR = '#60a5fa';

        function onDrop(source, target) {
            let move = game.move({ from: source, to: target, promotion: 'q' });
            if (move === null) return 'snapback';
            // Force Visual Update
            board.position(game.fen(), false);

            // Sync move highlight
            const fen = game.fen();
            const moveIdx = gameMoves.findIndex(m => m.fen === fen);
            if (moveIdx !== -1) currentMoveIndex = moveIdx;

            updateUI();
            fetchAnalysis();
        }

        function toggleEngine() {
            if (!$('#engine-toggle').is(':checked')) {
                const svg = document.getElementById('arrow-svg');
                while (svg.firstChild) svg.removeChild(svg.firstChild);
            }
            fetchAnalysis();
        }

        function updateUI() {
            // Redraw chessboard if resized
            board.resize();

            const bh = $('#myBoard').height();
            if (bh > 0) $('#eval-bar-v').height(bh);

            const fenKey = game.fen().split(' ').slice(0, 4).join(' ');
            const moves = treeData[fenKey] || {};
            const $body = $('#tree-body').empty();
            Object.keys(moves).sort((a, b) => moves[b].count - moves[a].count).forEach(m => {
                const s = moves[m];
                const wr = ((s.win / s.count) * 100).toFixed(1);
                $body.append(`<tr class="border-b border-gray-850 hover:bg-gray-750 cursor-pointer" onclick="playMove('${m}')">
                    <td class="py-3 font-bold text-blue-300 text-xs">${m}</td><td class="text-xs">${s.count}</td><td class="text-xs">${wr}%</td>
                    <td class="text-right text-[10px]"><span class="text-green-400">${s.win}W</span> / <span class="text-red-400">${s.loss}L</span></td></tr>`);
            });

            // Update Highlight
            $('.move-btn').removeClass('active');
            if (currentMoveIndex !== -1) {
                $(`#move-btn-${currentMoveIndex}`).addClass('active');
            }

            if (selectedGameId) {
                $('#annotation-box').removeClass('hidden');
                const moveData = gameMoves[currentMoveIndex];
                $('#comment-input').val(moveData && moveData.comment ? moveData.comment : '');
            }
        }

        function drawArrow(move, color, opacity, index) {
            const from = move.substring(0, 2);
            const to = move.substring(2, 4);
            const boardEl = document.getElementById('myBoard');
            const rect = boardEl.getBoundingClientRect();
            const sqSize = rect.width / 8;
            const getCoords = (sq) => {
                const col = sq.charCodeAt(0) - 97;
                const row = 8 - parseInt(sq[1]);
                return { x: col * sqSize + sqSize / 2, y: row * sqSize + sqSize / 2 };
            };
            const f = getCoords(from), t = getCoords(to);
            const svg = document.getElementById('arrow-svg');
            svg.setAttribute('width', rect.width);
            svg.setAttribute('height', rect.height);
            svg.setAttribute('viewBox', `0 0 ${rect.width} ${rect.height}`);
            const markerId = `arrowhead-${index}`;
            let defs = svg.querySelector('defs');
            if (!defs) { svg.appendChild(defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs')); }
            const marker = document.createElementNS('http://www.w3.org/2000/svg', 'marker');
            marker.setAttribute('id', markerId); marker.setAttribute('markerWidth', '6'); marker.setAttribute('markerHeight', '6');
            marker.setAttribute('refX', '5'); marker.setAttribute('refY', '3'); marker.setAttribute('orient', 'auto');
            const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            path.setAttribute('d', 'M0,0 L0,6 L6,3 Z'); path.setAttribute('fill', color); path.setAttribute('fill-opacity', opacity);
            marker.appendChild(path); defs.appendChild(marker);
            const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            line.setAttribute('x1', f.x); line.setAttribute('y1', f.y); line.setAttribute('x2', t.x); line.setAttribute('y2', t.y);
            
            // Dynamic arrow thickness: scaled with board width
            const strokeWidth = Math.max(2, rect.width * 0.012);
            line.setAttribute('stroke', color); line.setAttribute('stroke-width', strokeWidth); line.setAttribute('stroke-opacity', opacity);
            line.setAttribute('marker-end', `url(#${markerId})`);
            svg.appendChild(line);
        }

        function fetchAnalysis() {
            const svg = document.getElementById('arrow-svg');
            while (svg.firstChild) svg.removeChild(svg.firstChild);

            if (!$('#engine-toggle').is(':checked')) {
                $('#engine-status').text('Engine: Disabled');
                return;
            }

            $('#engine-status').text('Engine: Thinking...');
            $.get('/analyze?fen=' + encodeURIComponent(game.fen()), function (data) {
                if (!data || data.length === 0) return;
                while (svg.firstChild) svg.removeChild(svg.firstChild);
                $('#engine-status').text('Engine: Ready');
                const best = data[0];
                $('#eval-text').text((best.score / 100).toFixed(1));
                $('#eval-num').text(Math.abs(best.score / 100).toFixed(1));
                $('#eval-white-v').css('height', Math.max(5, Math.min(95, 50 + (best.score / 10))) + '%');

                const $lines = $('#engine-lines').empty();
                data.forEach((line, i) => {
                    const op = i === 0 ? 0.9 : (i === 1 ? 0.6 : 0.3);
                    drawArrow(line.best_move, ARROW_COLOR, op, i);
                    $lines.append(`<div class="bg-gray-750 p-2 rounded border text-xs" style="border-color: ${ARROW_COLOR}${Math.floor(op * 255).toString(16)}">
                        <div class="flex justify-between items-center">
                            <span style="color: ${ARROW_COLOR}" class="font-mono font-bold">${line.best_move}</span>
                            <span class="font-mono">${(line.score / 100).toFixed(1)}</span>
                        </div></div>`);
                });
            });
        }

        function showTab(tab) {
            $('.tab-content').addClass('hidden'); $(`#content-${tab}`).removeClass('hidden');
            $('.flex-1.py-3').removeClass('active-tab').addClass('text-gray-400');
            $(`#tab-${tab}`).addClass('active-tab').removeClass('text-gray-400');
        }

        function selectGame(id) {
            selectedGameId = id;
            const player = $('#player-filter').val();
            $.get('/games/' + id, function (data) {
                gameMoves = data.moves;
                $('#active-game-header').removeClass('hidden');
                $('#ag-players').text(`${data.white} vs ${data.black}`);
                $('#ag-meta').text(`${data.date} • ${data.result}`);
                if (player) {
                    if (data.white.toLowerCase().includes(player.toLowerCase())) board.orientation('white');
                    else if (data.black.toLowerCase().includes(player.toLowerCase())) board.orientation('black');
                }
                renderMoveList();
                showTab('moves');
                jumpToMove(-1);
            });
        }

        function renderMoveList() {
            const $mlist = $('#move-list').empty();
            let $row = null;
            gameMoves.forEach((m, i) => {
                if (i % 2 === 0) {
                    $mlist.append(`<div class="w-full text-[9px] text-gray-500 mt-3 mb-1 uppercase font-bold">Move ${Math.floor(i / 2) + 1}</div>`);
                    $row = $('<div class="flex w-full gap-2 mb-1"></div>').appendTo($mlist);
                }
                const hasComment = m.comment ? '<span class="comment-indicator">●</span>' : '';
                $row.append(`<button id="move-btn-${i}" onclick="jumpToMove(${i})" class="move-btn hover:bg-blue-600 px-2 py-1 rounded text-xs font-mono transition text-left">${m.san}${hasComment}</button>`);
                if (m.comment) {
                    $mlist.append(`<div class="comment-display italic">${m.comment}</div>`);
                }
            });
        }

        function jumpToMove(idx) {
            currentMoveIndex = idx;
            if (idx === -1) {
                game.reset();
            } else {
                const safeIdx = Math.max(-1, Math.min(idx, gameMoves.length - 1));
                currentMoveIndex = safeIdx;
                if (safeIdx === -1) {
                    game.reset();
                } else {
                    game.load(gameMoves[safeIdx].fen);
                }
            }
            board.position(game.fen(), false);
            updateUI();
            fetchAnalysis();
        }

        function jumpToFen(fen) {
            $('#engine-toggle').prop('checked', false);
            game.load(fen);
            board.orientation(game.turn() === 'w' ? 'white' : 'black');
            board.position(fen, false);
            const moveIdx = gameMoves.findIndex(m => m.fen === fen);
            currentMoveIndex = moveIdx;
            updateUI();
            fetchAnalysis();
        }

        function findPuzzles() {
            if (!selectedGameId) return alert("Select a game first!");
            $('#puzzle-list').html('<div class="text-xs text-blue-400 italic animate-pulse text-center">Scanning...</div>');
            $.get(`/games/${selectedGameId}/puzzles`, function (puzzles) {
                const $list = $('#puzzle-list').empty();
                if (puzzles.length === 0) {
                    $list.html('<div class="text-gray-500 text-xs text-center">No major blunders found.</div>');
                    return;
                }
                puzzles.forEach((p, i) => {
                    const diff = Math.abs(p.score_before - p.score_after) / 100;
                    const side = p.turn === 'white' ? 'White' : 'Black';
                    $list.append(`<div class="bg-gray-750 p-3 rounded border border-red-900/30 hover:border-red-500 cursor-pointer transition" onclick="jumpToPuzzle('${p.fen}')">
                        <div class="flex justify-between items-center">
                            <span class="text-xs font-bold text-red-400">Blunder by ${side} (Move ${p.move_number})</span>
                            <span class="text-[10px] text-gray-500">-${diff.toFixed(1)}</span>
                        </div>
                        <div class="text-[10px] text-gray-400 mt-1">Find a better move for ${side}</div>
                    </div>`);
                });
            });
        }

        function jumpToPuzzle(fen) {
            // Jump directly to the position before the blunder
            jumpToFen(fen);
        }

        function saveAnnotation() {
            if (!selectedGameId || currentMoveIndex === -1) return;
            const comment = $('#comment-input').val();
            const fen = game.fen();
            $.ajax({
                url: `/games/${selectedGameId}/annotate`,
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ fen: fen, comment: comment }),
                success: function () {
                    const m = gameMoves[currentMoveIndex];
                    if (m) m.comment = comment;
                    renderMoveList();
                    updateUI();
                    alert('Note saved!');
                }
            });
        }

        function loadData() {
            const p = $('#player-filter').val();
            $.get('/tree?player=' + p, data => { treeData = data; updateUI(); });
            $.get('/games', games => {
                const $list = $('#game-list').empty();
                games.forEach(g => {
                    const w = g.white || "?", b = g.black || "?";
                    const isW = p && w.toLowerCase().includes(p.toLowerCase()), isB = p && b.toLowerCase().includes(p.toLowerCase());
                    $list.append(`<div class="bg-gray-750 p-3 rounded border border-gray-700 text-sm hover:border-blue-500 cursor-pointer" onclick="selectGame(${g.id})">
                        <div class="flex justify-between items-start"><div><div class="font-bold text-xs"><span class="${isW ? 'highlight-player' : ''}">${w}</span> vs <span class="${isB ? 'highlight-player' : ''}">${b}</span></div>
                        <div class="text-gray-400 text-[10px]">${g.date} • ${g.result}</div></div>
                        <div class="flex flex-col items-end space-y-2"><button onclick="event.stopPropagation(); deleteGame(${g.id})" class="text-red-500 text-[10px]">Delete</button>
                        <div class="flex space-x-1"><button onclick="event.stopPropagation(); flipBoard('white')" class="bg-gray-600 px-1 rounded text-[9px]">W</button>
                        <button onclick="event.stopPropagation(); flipBoard('black')" class="bg-gray-600 px-1 rounded text-[9px]">B</button></div></div></div></div>`);
                });
            });
        }

        function deleteGame(id) { if (confirm('Delete?')) $.ajax({ url: '/games/' + id, type: 'DELETE', success: loadData }); }
        function flipBoard(s) { board.orientation(s); }
        $('#pgn-upload').change(function (e) {
            const fd = new FormData(); fd.append('file', e.target.files[0]);
            $.ajax({ url: '/upload', type: 'POST', data: fd, processData: false, contentType: false, success: loadData });
        });
        $('#player-filter').on('input', loadData);
        board = Chessboard('myBoard', { draggable: true, position: 'start', onDrop: onDrop, moveSpeed: 0, snapSpeed: 0, pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png' });
        loadData();

        $(window).resize(function() {
            board.resize();
            const bh = $('#myBoard').height();
            if (bh > 0) $('#eval-bar-v').height(bh);
            const svg = document.getElementById('arrow-svg');
            while (svg && svg.firstChild) svg.removeChild(svg.firstChild);
        });

        $('#btn-start').click(() => jumpToMove(-1));
        $('#btn-prev').click(() => jumpToMove(currentMoveIndex - 1));
        $('#btn-next').click(() => jumpToMove(currentMoveIndex + 1));
        $('#btn-end').click(() => jumpToMove(gameMoves.length - 1));

        $(document).keydown(function (e) {
            if ($("textarea, input").is(":focus")) return;
            if (e.which === 37) { e.preventDefault(); jumpToMove(currentMoveIndex - 1); }
            else if (e.which === 39) { e.preventDefault(); jumpToMove(currentMoveIndex + 1); }
            else if (e.which === 70) { e.preventDefault(); board.flip(); }
        });
    </script>
</body>

</html>
