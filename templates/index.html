<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chess Mimic ♟️ V2</title>
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; display: flex; height: 100vh; background: #1a1a1a; color: #eee; overflow: hidden; }
        #sidebar { width: 350px; background: #252525; display: flex; flex-direction: column; border-right: 1px solid #333; z-index: 10; }
        #main { flex: 1; position: relative; display: flex; align-items: center; justify-content: center; background: #111; overflow: hidden; padding: 20px; }
        #board-wrapper { position: relative; width: 800px; height: 800px; border: 2px solid #333; background: #000; }
        #board { width: 800px !important; height: 800px !important; }
        #arrow-overlay { position: absolute; top: 0; left: 0; width: 800px; height: 800px; pointer-events: none; z-index: 5; }
        .tabs { display: flex; background: #333; }
        .tab { flex: 1; padding: 12px; text-align: center; cursor: pointer; border-bottom: 3px solid transparent; font-weight: bold; font-size: 0.9em; color: #888; transition: 0.2s; }
        .tab.active { border-bottom: 3px solid #3498db; color: white; background: #3d3d3d; }
        .tab-content { flex: 1; overflow-y: auto; padding: 20px; display: none; }
        .tab-content.active { display: block; }
        h2 { margin-top: 0; font-size: 1.2em; color: #3498db; }
        .sidebar-section { margin-bottom: 25px; }
        label { display: block; margin-bottom: 8px; font-size: 0.85em; color: #aaa; text-transform: uppercase; letter-spacing: 1px; }
        select, input, button { width: 100%; padding: 12px; margin-top: 5px; border-radius: 4px; border: 1px solid #444; background: #333; color: white; box-sizing: border-box; }
        button { background: #3498db; border: none; cursor: pointer; font-weight: bold; transition: 0.2s; }
        button:hover { background: #2980b9; }
        .upload-form { background: #2d2d2d; padding: 15px; border-radius: 6px; border: 1px dashed #444; }
        .status-bar { padding: 10px; background: #3498db; color: white; text-align: center; font-weight: bold; font-size: 0.9em; margin-bottom: 20px; border-radius: 4px; }
        .move-row { display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #2d2d2d; border-radius: 4px; margin-bottom: 8px; border-left: 4px solid transparent; }
        .move-row.best { border-left-color: #2ecc71; background: #34495e; }
        .move-uci { font-family: monospace; font-size: 1.1em; font-weight: bold; }
        .move-score { font-size: 0.9em; color: #aaa; }
    </style>
</head>
<body>
    <div id="sidebar">
        <div class="tabs">
            <div class="tab active" onclick="switchTab('analysis')">ANALYSIS</div>
            <div class="tab" onclick="switchTab('settings')">SETTINGS</div>
        </div>
        <div id="tab-analysis" class="tab-content active">
            <div id="status-display" class="status-bar">White to move</div>
            <div class="sidebar-section">
                <label>Current Opponent</label>
                <select id="opponent-select" onchange="analyzeCurrent()">
                    <option value="me">Myself (Default)</option>
                    {% for opp in opponents %}
                    <option value="{{ opp }}">{{ opp }}</option>
                    {% endfor %}
                </select>
            </div>
            <div id="analysis-results">
                <div style="text-align: center; color: #666; margin-top: 50px;">Move a piece to begin analysis</div>
            </div>
        </div>
        <div id="tab-settings" class="tab-content">
            <h2>Game Management</h2>
            <div class="sidebar-section">
                <label>Upload Opponent PGN</label>
                <div class="upload-form">
                    <input type="text" id="opp-name" placeholder="Opponent Name">
                    <input type="file" id="pgn-file" accept=".pgn">
                    <button onclick="uploadPGN()">Upload & Process</button>
                </div>
                <div id="upload-status" style="margin-top: 10px; font-size: 0.8em;"></div>
            </div>
            <div class="sidebar-section">
                <label>Board Controls</label>
                <button onclick="resetBoard()" style="background: #e74c3c; margin-bottom: 10px;">Reset Game</button>
                <button onclick="flipBoard()" style="background: #444;">Flip Board View</button>
            </div>
        </div>
    </div>
    <div id="main">
        <div id="board-wrapper">
            <div id="board"></div>
            <svg id="arrow-overlay" width="800" height="800" viewBox="0 0 800 800"></svg>
        </div>
    </div>
    <script>
        var board = null;
        var game = new Chess();
        var $overlay = $('#arrow-overlay');
        function switchTab(tabId) {
            $('.tab').removeClass('active');
            $('.tab-content').removeClass('active');
            $(`.tab:contains('${tabId.toUpperCase()}')`).addClass('active');
            $(`#tab-${tabId}`).addClass('active');
        }
        function getSquareCenter(square) {
            var files = 'abcdefgh';
            var ranks = '87654321';
            var file = files.indexOf(square[0]);
            var rank = ranks.indexOf(square[1]);
            if (board.orientation() === 'black') {
                file = 7 - file;
                rank = 7 - rank;
            }
            var rect = document.getElementById('board').getBoundingClientRect();
            var sqSize = rect.width / 8;
            return { x: file * sqSize + sqSize / 2, y: rank * sqSize + sqSize / 2 };
        }
        function drawArrow(from, to, color, width=6) {
            var start = getSquareCenter(from);
            var end = getSquareCenter(to);
            var id = 'arrow-' + from + '-' + to;
            var markerId = 'head-' + id;
            if ($('#' + markerId).length === 0) {
                var marker = document.createElementNS('http://www.w3.org/2000/svg', 'marker');
                marker.setAttribute('id', markerId); marker.setAttribute('markerWidth', '6'); marker.setAttribute('markerHeight', '6');
                marker.setAttribute('refX', '0'); marker.setAttribute('refY', '3'); marker.setAttribute('orient', 'auto');
                var path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                path.setAttribute('d', 'M0,0 L0,6 L6,3 z'); path.setAttribute('fill', color);
                marker.appendChild(path); $overlay.append(marker);
            }
            var dx = end.x - start.x; var dy = end.y - start.y; var len = Math.sqrt(dx*dx + dy*dy);
            var shorten = 10; var actualEndX = end.x - (dx / len) * shorten; var actualEndY = end.y - (dy / len) * shorten;
            var line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            line.setAttribute('x1', start.x); line.setAttribute('y1', start.y);
            line.setAttribute('x2', actualEndX); line.setAttribute('y2', actualEndY);
            line.setAttribute('stroke', color); line.setAttribute('stroke-width', width);
            line.setAttribute('marker-end', 'url(#' + markerId + ')'); line.setAttribute('opacity', '0.7');
            $overlay.append(line);
        }
        function clearArrows() { $overlay.empty() }
        function flipBoard() { board.flip(); analyzeCurrent(); }
        function uploadPGN() {
            var file = $('#pgn-file')[0].files[0];
            var name = $('#opp-name').val();
            if (!file || !name) { alert("Please provide name and file"); return; }
            var formData = new FormData();
            formData.append('file', file); formData.append('name', name);
            $('#upload-status').text('Processing...');
            $.ajax({
                url: '/upload', type: 'POST', data: formData, processData: false, contentType: false,
                success: function() { location.reload(); },
                error: function() { $('#upload-status').text('Error uploading.'); }
            });
        }
        function onDrop (source, target) {
            var move = game.move({ from: source, to: target, promotion: 'q' });
            if (move === null) return 'snapback';
            updateStatus(); analyzeCurrent();
        }
        function updateStatus () {
            var moveColor = game.turn() === 'b' ? 'Black' : 'White';
            var status = moveColor + ' to move';
            if (game.in_checkmate()) status = 'Checkmate!';
            else if (game.in_draw()) status = 'Draw';
            $('#status-display').text(status);
        }
        function analyzeCurrent() {
            var fen = game.fen();
            var opp = $('#opponent-select').val();
            $('#analysis-results').html('<div style="text-align:center; padding:20px;">Engine Thinking...</div>');
            clearArrows();
            $.ajax({
                url: '/analyze', type: 'POST', contentType: 'application/json',
                data: JSON.stringify({ fen: fen, opponent: opp }),
                success: function(data) {
                    var html = '<h2>Stockfish Recommendation</h2>';
                    if (data.stockfish.best_move) {
                        drawArrow(data.stockfish.best_move.substring(0,2), data.stockfish.best_move.substring(2,4), '#3498db', 6);
                        html += `<div class="move-row best"><span class="move-uci" style="color:#3498db">➡ ${data.stockfish.best_move}</span><span class="move-score">CP: ${(data.stockfish.score/100).toFixed(2)}</span></div>`;
                    }
                    html += `<h2 style="margin-top:30px;">${opp === 'me' ? 'My' : opp + "'s"} Historical Moves</h2>`;
                    if (data.mimic && data.mimic.length > 0) {
                        data.mimic.forEach(m => {
                            var color = m.is_best ? '#2ecc71' : '#f39c12';
                            if (!m.is_best) drawArrow(m.move.substring(0,2), m.move.substring(2,4), color, 4);
                            html += `<div class="move-row"><span class="move-uci" style="color:${color}">➡ ${m.move} (${m.count}x)</span><span class="move-score">Diff: ${((data.stockfish.score - m.score)/100).toFixed(2)}</span></div>`;
                        });
                    } else { html += '<p style="color:#666">No historical data for this position.</p>'; }
                    $('#analysis-results').html(html);
                }
            });
        }
        $(document).ready(function() {
            board = Chessboard('board', {
                draggable: true, 
                position: 'start', 
                onDragStart: (s, p) => !game.game_over() && !((game.turn() === 'w' && p.search(/^b/) !== -1) || (game.turn() === 'b' && p.search(/^w/) !== -1)),
                onDrop: onDrop, 
                onSnapEnd: () => board.position(game.fen()),
                pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png'
            });
            updateStatus();
            setTimeout(function() { board.resize(); }, 500);
        });
    </script>
</body>
</html>
