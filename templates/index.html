<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chess Mimic - Professional Practice</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <style>
        .active-tab {
            border-bottom: 2px solid #3b82f6;
            color: #3b82f6;
        }

        .highlight-player {
            color: #3b82f6;
            font-weight: bold;
        }

        #board-container {
            position: relative;
        }

        #arrow-svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 100;
        }

        #eval-bar-v {
            width: 30px;
            flex-shrink: 0;
            background: #374151;
            border-radius: 2px;
            overflow: visible;
            display: flex;
            flex-direction: column-reverse;
            position: relative;
        }

        #eval-white-v {
            background: white;
            width: 100%;
            transition: height 0.5s ease;
        }

        #eval-num {
            position: absolute;
            width: 100%;
            text-align: center;
            font-size: 11px;
            font-weight: bold;
            color: #ff00ff;
            z-index: 50;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
            text-shadow: 1px 1px 1px black;
        }

        /* Drag & Drop */
        .game-draggable.dragging {
            opacity: 0.4;
        }

        .folder-drop-zone.drag-over>.folder-header {
            outline: 2px dashed #3b82f6;
            outline-offset: -2px;
            background: rgba(59, 130, 246, 0.1);
        }

        .drag-grip:hover {
            color: #9ca3af;
        }

        .move-btn {
            background: #374151;
            border: 1px solid transparent;
            flex: 1;
            min-width: 45%;
            max-width: 48%;
        }

        .move-btn.active {
            border-color: #3b82f6;
            background: #1e3a8a !important;
            font-weight: bold;
        }

        .comment-display {
            width: 100%;
            font-size: 10px;
            color: #fbbf24;
            padding: 4px 8px;
            background: #1f2937;
            border-radius: 4px;
            margin: 4px 0 8px 0;
            border-left: 2px solid #fbbf24;
        }

        .comment-indicator {
            color: #fbbf24;
            margin-left: 2px;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 34px;
            height: 20px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #4b5563;
            transition: .4s;
            border-radius: 20px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 14px;
            width: 14px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked+.slider {
            background-color: #3b82f6;
        }

        input:checked+.slider:before {
            transform: translateX(14px);
        }
    </style>
</head>

<body class="bg-gray-900 text-white font-sans md:overflow-hidden">
    <div class="flex flex-col min-h-screen md:h-screen">
        <header
            class="bg-gray-800 px-3 py-2 border-b border-gray-700 flex flex-col md:flex-row justify-between items-center h-auto md:h-16 overflow-hidden flex-shrink-0">
            <h1 class="text-lg font-bold text-blue-400">‚ôüÔ∏è Chess Mimic</h1>
            <div class="flex flex-wrap items-center justify-center gap-3">
                <div class="flex items-center space-x-2">
                    <span class="text-[10px] text-gray-500 uppercase font-bold">Engine</span>
                    <label class="switch">
                        <input type="checkbox" id="engine-toggle" checked onchange="toggleEngine()">
                        <span class="slider"></span>
                    </label>
                </div>
                <div id="engine-status" class="text-[10px] text-gray-500 font-mono w-24 text-center truncate">Engine:
                    Idle</div>
                <input type="text" id="player-filter" placeholder="Filter..."
                    class="bg-gray-700 border border-gray-600 rounded px-2 py-0.5 text-xs focus:outline-none w-20 md:w-auto">
                <input type="file" id="pgn-upload" class="hidden">
                <button onclick="$('#pgn-upload').click()"
                    class="bg-blue-600 hover:bg-blue-500 px-3 py-0.5 rounded text-xs font-medium">Upload</button>
            </div>
        </header>

        <main class="flex flex-col md:flex-row flex-1 overflow-y-auto md:overflow-hidden">
            <div id="board-area"
                class="w-full md:w-2/3 p-2 flex flex-col items-center justify-start bg-gray-850 overflow-hidden">
                <div id="board-container" class="relative flex space-x-2 h-fit items-start">
                    <div id="eval-bar-v" class="border border-gray-700">
                        <div id="eval-num">0.0</div>
                        <div id="eval-white-v" style="height: 50%"></div>
                    </div>
                    <div id="board-wrapper" class="relative">
                        <div id="myBoard" class="w-full"></div>
                        <svg id="arrow-svg"></svg>
                    </div>
                </div>
                <div id="eval-chart-wrap" class="hidden mt-1 cursor-pointer" title="Click to jump to a move">
                    <canvas id="eval-chart" height="120"></canvas>
                </div>
            </div>

            <div
                class="w-full md:w-1/3 bg-gray-800 border-t md:border-t-0 md:border-l border-gray-700 flex flex-col min-h-[400px] md:min-h-0">
                <div class="flex border-b border-gray-700 text-center">
                    <button onclick="showTab('tree')" id="tab-tree"
                        class="flex-1 py-3 text-xs font-medium active-tab uppercase">Tree</button>
                    <button onclick="showTab('games')" id="tab-games"
                        class="flex-1 py-3 text-xs font-medium text-gray-400 uppercase">Games</button>
                    <button onclick="showTab('moves')" id="tab-moves"
                        class="flex-1 py-3 text-xs font-medium text-gray-400 uppercase">Moves</button>

                    <button onclick="showTab('analysis')" id="tab-analysis"
                        class="flex-1 py-3 text-xs font-medium text-gray-400 uppercase">Engine</button>
                </div>

                <div class="flex-1 overflow-y-auto p-4">
                    <div id="content-tree" class="tab-content">
                        <table class="w-full text-left text-sm">
                            <thead class="text-gray-500 border-b border-gray-700">
                                <tr>
                                    <th class="pb-2">Move</th>
                                    <th class="pb-2">Count</th>
                                    <th class="pb-2">Win %</th>
                                    <th class="pb-2 text-right">Result</th>
                                </tr>
                            </thead>
                            <tbody id="tree-body"></tbody>
                        </table>
                    </div>
                    <div id="content-games" class="tab-content hidden">
                        <!-- Lichess Import Panel -->
                        <div class="mb-4">
                            <div class="flex items-center gap-2 cursor-pointer mb-2"
                                onclick="$('#lichess-panel').toggleClass('hidden')">
                                <span class="text-[13px]">‚ôû</span>
                                <span class="text-[11px] font-bold text-purple-300">Import from Lichess</span>
                                <span class="text-[9px] text-gray-500">‚ñº</span>
                            </div>
                            <div id="lichess-panel"
                                class="hidden bg-gray-800/50 border border-gray-700 rounded p-3 space-y-2">
                                <div class="flex gap-2">
                                    <input type="text" id="lichess-username" placeholder="Lichess username"
                                        class="flex-1 bg-gray-700 border border-gray-600 rounded px-2 py-1 text-[11px] text-white focus:outline-none focus:border-purple-500">
                                    <input type="password" id="lichess-token"
                                        placeholder="API token (optional, for private studies)"
                                        class="flex-1 bg-gray-700 border border-gray-600 rounded px-2 py-1 text-[11px] text-white focus:outline-none focus:border-purple-500">
                                </div>
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center gap-2">
                                        <button onclick="browseLichessStudies()"
                                            class="bg-purple-600 hover:bg-purple-500 text-white px-3 py-1 rounded text-[10px] font-medium">Browse
                                            Studies</button>
                                        <button onclick="saveLichessSettings()"
                                            class="text-[9px] text-gray-400 hover:text-gray-300">Save Settings</button>
                                    </div>
                                    <a href="https://lichess.org/account/oauth/token" target="_blank"
                                        class="text-[9px] text-purple-400 hover:underline">Get API token ‚Üí</a>
                                </div>
                                <div id="lichess-status" class="text-[10px] text-gray-500 italic hidden"></div>
                                <div id="lichess-studies" class="space-y-1 hidden"></div>
                            </div>
                        </div>
                        <div id="game-list" class="space-y-2"></div>
                    </div>
                    <div id="content-moves" class="tab-content hidden flex flex-col h-full">
                        <div id="active-game-header" class="mb-4 pb-2 border-b border-gray-700 hidden">
                            <div class="font-bold text-blue-400 text-sm" id="ag-players"></div>
                            <div class="text-[10px] text-gray-400" id="ag-meta"></div>
                        </div>
                        <div id="move-list" class="flex flex-wrap gap-1 mb-4">
                            <div class="text-gray-500 text-xs italic text-center w-full">Select a game...</div>
                        </div>
                        <div id="annotation-box" class="mt-auto border-t border-gray-700 pt-4 hidden">
                            <label class="block text-[10px] font-bold text-gray-500 uppercase mb-2">Move
                                Annotation</label>
                            <textarea id="comment-input"
                                class="w-full bg-gray-900 border border-gray-700 rounded p-2 text-sm text-gray-300 focus:outline-none focus:border-blue-500"
                                rows="3" placeholder="Add notes..."></textarea>
                            <div class="flex justify-end mt-2">
                                <button onclick="saveAnnotation()"
                                    class="bg-blue-600 hover:bg-blue-500 px-3 py-1 rounded text-xs font-medium">Save
                                    Note</button>
                            </div>
                        </div>
                    </div>

                    <div id="content-analysis" class="tab-content hidden">
                        <div id="engine-lines" class="space-y-3"></div>
                    </div>
                </div>
                <div class="p-4 border-t border-gray-700 bg-gray-850 flex justify-between items-center flex-shrink-0">
                    <div class="flex space-x-1">
                        <button id="btn-start"
                            class="bg-gray-700 hover:bg-gray-600 px-3 py-1 rounded text-sm">|&lt;</button>
                        <button id="btn-prev"
                            class="bg-gray-700 hover:bg-gray-600 px-3 py-1 rounded text-sm">&lt;</button>
                        <button id="btn-next"
                            class="bg-gray-700 hover:bg-gray-600 px-3 py-1 rounded text-sm">&gt;</button>
                        <button id="btn-end"
                            class="bg-gray-700 hover:bg-gray-600 px-3 py-1 rounded text-sm">&gt;|</button>
                    </div>
                    <div id="eval-text" class="font-mono text-sm text-gray-400">0.0</div>
                </div>
            </div>
        </main>
    </div>

    <script>
        let board = null;
        let game = new Chess();
        let treeData = {};
        let selectedGameId = null;
        let currentMoveIndex = -1; // -1 is start position
        let gameMoves = [];
        let gameEvals = [];
        const ARROW_COLOR = '#60a5fa';

        function onDrop(source, target) {
            let move = game.move({ from: source, to: target, promotion: 'q' });
            if (move === null) return 'snapback';
            // Force Visual Update
            board.position(game.fen(), false);

            // Sync move highlight
            const fen = game.fen();
            const moveIdx = gameMoves.findIndex(m => m.fen === fen);
            if (moveIdx !== -1) currentMoveIndex = moveIdx;

            updateUI();
            fetchAnalysis();
        }

        function toggleEngine() {
            if (!$('#engine-toggle').is(':checked')) {
                const svg = document.getElementById('arrow-svg');
                while (svg.firstChild) svg.removeChild(svg.firstChild);
            }
            fetchAnalysis();
        }

        function updateUI() {
            // Redraw chessboard if resized
            board.resize();

            const bh = $('#myBoard').height();
            if (bh > 0) $('#eval-bar-v').height(bh);

            const fenKey = game.fen().split(' ').slice(0, 4).join(' ');
            const moves = treeData[fenKey] || {};
            const $body = $('#tree-body').empty();
            Object.keys(moves).sort((a, b) => moves[b].count - moves[a].count).forEach(m => {
                const s = moves[m];
                const wr = ((s.win / s.count) * 100).toFixed(1);
                $body.append(`<tr class="border-b border-gray-850 hover:bg-gray-750 cursor-pointer" onclick="playMove('${m}')">
                    <td class="py-3 font-bold text-blue-300 text-xs">${m}</td><td class="text-xs">${s.count}</td><td class="text-xs">${wr}%</td>
                    <td class="text-right text-[10px]"><span class="text-green-400">${s.win}W</span> / <span class="text-red-400">${s.loss}L</span></td></tr>`);
            });

            // Update Highlight
            $('.move-btn').removeClass('active');
            if (currentMoveIndex !== -1) {
                $(`#move-btn-${currentMoveIndex}`).addClass('active');
            }

            if (selectedGameId) {
                $('#annotation-box').removeClass('hidden');
                const moveData = gameMoves[currentMoveIndex];
                $('#comment-input').val(moveData && moveData.comment ? moveData.comment : '');
            }
        }

        function drawArrow(move, color, opacity, index) {
            const from = move.substring(0, 2);
            const to = move.substring(2, 4);
            const boardEl = document.getElementById('myBoard');
            const rect = boardEl.getBoundingClientRect();
            const sqSize = rect.width / 8;
            const isFlipped = board.orientation() === 'black';
            const getCoords = (sq) => {
                let col = sq.charCodeAt(0) - 97;
                let row = 8 - parseInt(sq[1]);
                if (isFlipped) { col = 7 - col; row = 7 - row; }
                return { x: col * sqSize + sqSize / 2, y: row * sqSize + sqSize / 2 };
            };
            const f = getCoords(from), t = getCoords(to);
            const svg = document.getElementById('arrow-svg');
            svg.setAttribute('width', rect.width);
            svg.setAttribute('height', rect.height);
            svg.setAttribute('viewBox', `0 0 ${rect.width} ${rect.height}`);
            const markerId = `arrowhead-${index}`;
            let defs = svg.querySelector('defs');
            if (!defs) { svg.appendChild(defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs')); }
            const marker = document.createElementNS('http://www.w3.org/2000/svg', 'marker');
            marker.setAttribute('id', markerId); marker.setAttribute('markerWidth', '6'); marker.setAttribute('markerHeight', '6');
            marker.setAttribute('refX', '5'); marker.setAttribute('refY', '3'); marker.setAttribute('orient', 'auto');
            const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            path.setAttribute('d', 'M0,0 L0,6 L6,3 Z'); path.setAttribute('fill', color); path.setAttribute('fill-opacity', opacity);
            marker.appendChild(path); defs.appendChild(marker);
            const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            line.setAttribute('x1', f.x); line.setAttribute('y1', f.y); line.setAttribute('x2', t.x); line.setAttribute('y2', t.y);

            // Dynamic arrow thickness: scaled with board width
            const strokeWidth = Math.max(2, rect.width * 0.012);
            line.setAttribute('stroke', color); line.setAttribute('stroke-width', strokeWidth); line.setAttribute('stroke-opacity', opacity);
            line.setAttribute('marker-end', `url(#${markerId})`);
            svg.appendChild(line);
        }

        function fetchAnalysis() {
            const svg = document.getElementById('arrow-svg');
            while (svg.firstChild) svg.removeChild(svg.firstChild);

            if (!$('#engine-toggle').is(':checked')) {
                $('#engine-status').text('Engine: Disabled');
                return;
            }

            $('#engine-status').text('Engine: Thinking...');
            $.get('/analyze?fen=' + encodeURIComponent(game.fen()), function (data) {
                if (!data) return;
                while (svg.firstChild) svg.removeChild(svg.firstChild);
                $('#engine-status').text('Engine: Ready');

                // 1. Tactical (Engine)
                const tactical = data.tactical;
                if (tactical && tactical.length > 0) {
                    const best = tactical[0];
                    $('#eval-text').text((best.score / 100).toFixed(1));
                    $('#eval-num').text(Math.abs(best.score / 100).toFixed(1));
                    const whiteHeight = Math.max(5, Math.min(95, 50 + (best.score / 10)));
                    $('#eval-white-v').css('height', whiteHeight + '%');
                    // Flip eval bar direction when board is flipped to black
                    const isBlack = board.orientation() === 'black';
                    $('#eval-bar-v').css('flex-direction', isBlack ? 'column' : 'column-reverse');

                    const $lines = $('#engine-lines').empty();
                    $lines.append(`<div class="text-[10px] font-bold text-gray-500 uppercase mb-1">Top Lines</div>`);
                    tactical.forEach((line, i) => {
                        const op = i === 0 ? 0.9 : (i === 1 ? 0.6 : 0.3);
                        drawArrow(line.best_move, ARROW_COLOR, op, i);
                        $lines.append(`<div class="bg-gray-750 p-2 rounded border text-xs mb-1" style="border-color: ${ARROW_COLOR}${Math.floor(op * 255).toString(16)}">
                            <div class="flex justify-between items-center">
                                <span style="color: ${ARROW_COLOR}" class="font-mono font-bold">${line.best_move}</span>
                                <span class="font-mono">${(line.score / 100).toFixed(1)}</span>
                            </div></div>`);
                    });
                }

                // 2. Positional Insights
                const positional = data.positional;
                const $insights = $('#engine-lines'); // Append to same tab for now
                if (positional && positional.length > 0) {
                    $insights.append(`<div class="text-[10px] font-bold text-gray-500 uppercase mt-4 mb-2">Positional Insights</div>`);
                    positional.forEach(p => {
                        const colorClass = p.severity === 'High' ? 'text-red-400' : (p.severity === 'Good' ? 'text-green-400' : 'text-yellow-400');
                        $insights.append(`<div class="bg-gray-900/50 p-2 rounded border border-gray-700 text-[10px] mb-1">
                            <div class="font-bold ${colorClass}">${p.type} (${p.square})</div>
                            <div class="text-gray-400 italic">${p.description}</div>
                        </div>`);
                    });
                }
            });
        }

        function showTab(tab) {
            $('.tab-content').addClass('hidden'); $(`#content-${tab}`).removeClass('hidden');
            $('.flex-1.py-3').removeClass('active-tab').addClass('text-gray-400');
            $(`#tab-${tab}`).addClass('active-tab').removeClass('text-gray-400');
        }

        function selectGame(id, callback) {
            selectedGameId = id;
            const player = $('#player-filter').val();
            $.get('/games/' + id, function (data) {
                gameMoves = data.moves;
                gameEvals = data.evals || [];
                $('#active-game-header').removeClass('hidden');
                $('#ag-players').text(`${data.white} vs ${data.black}`);
                $('#ag-meta').text(`${data.date} ‚Ä¢ ${data.result}`);
                if (player) {
                    if (data.white.toLowerCase().includes(player.toLowerCase())) board.orientation('white');
                    else if (data.black.toLowerCase().includes(player.toLowerCase())) board.orientation('black');
                }
                renderMoveList();
                showTab('moves');
                drawEvalChart(gameEvals, -1);
                if (callback) {
                    callback();
                } else {
                    jumpToMove(-1);
                }
            });
        }

        function renderMoveList() {
            const $mlist = $('#move-list').empty();
            let $row = null;
            gameMoves.forEach((m, i) => {
                if (i % 2 === 0) {
                    $mlist.append(`<div class="w-full text-[9px] text-gray-500 mt-3 mb-1 uppercase font-bold">Move ${Math.floor(i / 2) + 1}</div>`);
                    $row = $('<div class="flex w-full gap-2 mb-1"></div>').appendTo($mlist);
                }
                const hasComment = m.comment ? '<span class="comment-indicator">‚óè</span>' : '';
                $row.append(`<button id="move-btn-${i}" onclick="jumpToMove(${i})" class="move-btn hover:bg-blue-600 px-2 py-1 rounded text-xs font-mono transition text-left">${m.san}${hasComment}</button>`);
                if (m.comment) {
                    $mlist.append(`<div class="comment-display italic">${m.comment}</div>`);
                }
            });
        }

        // --- Eval Chart ---
        function drawEvalChart(evals, highlightIdx) {
            if (!evals || !evals.length) {
                const wasVisible = !$('#eval-chart-wrap').hasClass('hidden');
                $('#eval-chart-wrap').addClass('hidden');
                if (wasVisible) { resizeBoardArea(); board.resize(); const bh = $('#myBoard').height(); if (bh > 0) $('#eval-bar-v').height(bh); }
                return;
            }
            const wasHidden = $('#eval-chart-wrap').hasClass('hidden');
            const $wrap = $('#eval-chart-wrap').removeClass('hidden');
            // If chart just became visible, re-compute board size to make room
            if (wasHidden) {
                resizeBoardArea();
                board.resize();
                const bh = $('#myBoard').height();
                if (bh > 0) $('#eval-bar-v').height(bh);
            }
            const canvas = document.getElementById('eval-chart');
            const w = $wrap.width();
            canvas.width = w;
            const h = canvas.height;
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, w, h);

            // Clamp evals to [-1000, 1000] for display (¬±10 pawns)
            const maxEval = 1000;
            const clamped = evals.map(e => Math.max(-maxEval, Math.min(maxEval, e)));
            const mid = h / 2;

            // Background: top half white tinted, bottom half dark
            ctx.fillStyle = 'rgba(255,255,255,0.06)';
            ctx.fillRect(0, 0, w, mid);
            ctx.fillStyle = 'rgba(0,0,0,0.15)';
            ctx.fillRect(0, mid, w, mid);

            const toY = (ev) => mid - (ev / maxEval) * mid;

            // Horizontal grid lines at ¬±1, ¬±3, ¬±5 pawns (100, 300, 500 cp)
            const gridLevels = [100, 300, 500, -100, -300, -500];
            ctx.setLineDash([2, 3]);
            ctx.lineWidth = 0.5;
            gridLevels.forEach(cp => {
                const gy = toY(cp);
                ctx.strokeStyle = 'rgba(255,255,255,0.08)';
                ctx.beginPath();
                ctx.moveTo(0, gy);
                ctx.lineTo(w, gy);
                ctx.stroke();
                // Label
                const label = (cp > 0 ? '+' : '') + (cp / 100);
                ctx.fillStyle = 'rgba(255,255,255,0.2)';
                ctx.font = '8px sans-serif';
                ctx.textAlign = 'left';
                ctx.fillText(label, 3, gy - 2);
            });
            ctx.setLineDash([]);

            // Zero line (bolder)
            ctx.strokeStyle = 'rgba(255,255,255,0.25)';
            ctx.lineWidth = 1;
            ctx.setLineDash([4, 4]);
            ctx.beginPath();
            ctx.moveTo(0, mid);
            ctx.lineTo(w, mid);
            ctx.stroke();
            ctx.setLineDash([]);
            // Zero label
            ctx.fillStyle = 'rgba(255,255,255,0.3)';
            ctx.font = '9px sans-serif';
            ctx.textAlign = 'left';
            ctx.fillText('0', 3, mid - 3);

            // Fill area under/above the eval line
            const step = w / Math.max(clamped.length - 1, 1);

            // Filled area (white = positive, dark = negative)
            ctx.beginPath();
            ctx.moveTo(0, mid);
            for (let i = 0; i < clamped.length; i++) {
                ctx.lineTo(i * step, toY(clamped[i]));
            }
            ctx.lineTo((clamped.length - 1) * step, mid);
            ctx.closePath();
            const grad = ctx.createLinearGradient(0, 0, 0, h);
            grad.addColorStop(0, 'rgba(255,255,255,0.35)');
            grad.addColorStop(0.5, 'rgba(255,255,255,0.05)');
            grad.addColorStop(0.5, 'rgba(0,0,0,0.05)');
            grad.addColorStop(1, 'rgba(50,50,50,0.35)');
            ctx.fillStyle = grad;
            ctx.fill();

            // Main eval line
            ctx.beginPath();
            for (let i = 0; i < clamped.length; i++) {
                const x = i * step, y = toY(clamped[i]);
                i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
            }
            ctx.strokeStyle = 'rgba(200,200,200,0.7)';
            ctx.lineWidth = 1.5;
            ctx.stroke();

            // Highlight current move indicator
            if (typeof highlightIdx === 'number' && highlightIdx >= 0 && highlightIdx < clamped.length) {
                const hx = highlightIdx * step;
                ctx.strokeStyle = 'rgba(239,68,68,0.8)';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(hx, 0);
                ctx.lineTo(hx, h);
                ctx.stroke();
                // Dot on the eval point
                ctx.fillStyle = '#ef4444';
                ctx.beginPath();
                ctx.arc(hx, toY(clamped[highlightIdx]), 3.5, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        function updateChartIndicator() {
            drawEvalChart(gameEvals, currentMoveIndex);
        }

        // Click on chart -> jump to that move
        $('#eval-chart').on('click', function (e) {
            if (!gameEvals.length || !gameMoves.length) return;
            const rect = this.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const ratio = x / rect.width;
            const idx = Math.round(ratio * (gameEvals.length - 1));
            jumpToMove(Math.max(0, Math.min(idx, gameMoves.length - 1)));
        });

        function jumpToMove(idx) {
            currentMoveIndex = idx;
            if (idx === -1) {
                game.reset();
            } else {
                const safeIdx = Math.max(-1, Math.min(idx, gameMoves.length - 1));
                currentMoveIndex = safeIdx;
                if (safeIdx === -1) {
                    game.reset();
                } else {
                    game.load(gameMoves[safeIdx].fen);
                }
            }
            board.position(game.fen(), false);
            updateUI();
            fetchAnalysis();
            updateChartIndicator();
        }

        function jumpToFen(fen) {
            $('#engine-toggle').prop('checked', false);
            game.load(fen);
            board.orientation(game.turn() === 'w' ? 'white' : 'black');
            board.position(fen, false);
            const moveIdx = gameMoves.findIndex(m => m.fen === fen);
            currentMoveIndex = moveIdx;
            updateUI();
            fetchAnalysis();
        }

        function findPuzzles() {
            if (!selectedGameId) return alert("Select a game first!");
            $('#puzzle-list').html('<div class="text-xs text-blue-400 italic animate-pulse text-center">Scanning...</div>');
            $.get(`/games/${selectedGameId}/puzzles`, function (puzzles) {
                const $list = $('#puzzle-list').empty();
                if (puzzles.length === 0) {
                    $list.html('<div class="text-gray-500 text-xs text-center">No major blunders found.</div>');
                    return;
                }
                puzzles.forEach((p, i) => {
                    const diff = Math.abs(p.score_before - p.score_after) / 100;
                    const side = p.turn === 'white' ? 'White' : 'Black';
                    $list.append(`<div class="bg-gray-750 p-3 rounded border border-red-900/30 hover:border-red-500 cursor-pointer transition" onclick="jumpToPuzzle('${p.fen}')">
                        <div class="flex justify-between items-center">
                            <span class="text-xs font-bold text-red-400">Blunder by ${side} (Move ${p.move_number})</span>
                            <span class="text-[10px] text-gray-500">-${diff.toFixed(1)}</span>
                        </div>
                        <div class="text-[10px] text-gray-400 mt-1">Find a better move for ${side}</div>
                    </div>`);
                });
            });
        }

        function jumpToPuzzle(fen) {
            // Jump directly to the position before the blunder
            jumpToFen(fen);
        }

        function saveAnnotation() {
            if (!selectedGameId || currentMoveIndex === -1) return;
            const comment = $('#comment-input').val();
            const fen = game.fen();
            $.ajax({
                url: `/games/${selectedGameId}/annotate`,
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ fen: fen, comment: comment }),
                success: function () {
                    const m = gameMoves[currentMoveIndex];
                    if (m) m.comment = comment;
                    renderMoveList();
                    updateUI();
                    alert('Note saved!');
                }
            });
        }

        function loadData() {
            const p = $('#player-filter').val();
            $.get('/tree?player=' + p, data => { treeData = data; updateUI(); });

            // Fetch folders and games together
            $.when($.get('/folders'), $.get('/games')).done(function (foldersRes, gamesRes) {
                const folderData = foldersRes[0];
                const folders = folderData.folders;
                const unfiled = folderData.unfiled;
                const games = gamesRes[0];
                const $list = $('#game-list').empty();

                // "New Folder" button
                $list.append(`<div class="mb-3">
                    <button onclick="createFolder()" class="bg-blue-600 hover:bg-blue-500 px-3 py-1 rounded text-[10px] font-medium">+ New Folder</button>
                </div>`);

                // Group games by folder_id
                const gamesByFolder = {};
                games.forEach(g => {
                    const fid = g.folder_id || '__unfiled__';
                    if (!gamesByFolder[fid]) gamesByFolder[fid] = [];
                    gamesByFolder[fid].push(g);
                });

                // Render each folder
                folders.forEach(f => {
                    const folderGames = gamesByFolder[f.id] || [];
                    $list.append(renderFolderSection(f, folderGames, p));
                });

                // Render unfiled games
                const unfiledGames = gamesByFolder['__unfiled__'] || [];
                $list.append(`<div class="space-y-1 folder-drop-zone" data-folder-id=""
                     ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" ondrop="handleDrop(event)">
                    <div class="folder-header"></div>
                    ${unfiledGames.map(g => renderGameItem(g, p)).join('')}
                    ${unfiledGames.length === 0 ? '<div class="border border-dashed border-gray-700 rounded p-3 text-center text-[10px] text-gray-600 mt-2">Drop here to remove from folder</div>' : ''}
                </div>`);
            });
        }

        function renderFolderSection(folder, games, player) {
            const gamesHtml = games.map(g => renderGameItem(g, player)).join('');
            return `
                <div class="mb-3 folder-drop-zone" data-folder-id="${folder.id}"
                     ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" ondrop="handleDrop(event)">
                    <div class="flex justify-between items-center bg-gray-700/50 px-3 py-2 rounded-t cursor-pointer folder-header"
                         onclick="toggleFolderIcon(${folder.id})">
                        <div class="flex items-center gap-2">
                            <span id="folder-icon-${folder.id}" class="text-[13px]">üìÇ</span>
                            <span class="text-[11px] font-bold text-blue-300 cursor-pointer hover:underline" onclick="event.stopPropagation(); renameFolder(${folder.id}, '${folder.name.replace(/'/g, "\\'")}')">${folder.name}</span>
                            <span class="text-[9px] text-gray-500">${folder.game_count} games ‚Ä¢ ${folder.puzzle_count} puzzles</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <button onclick="event.stopPropagation(); scanFolder(${folder.id})" id="scan-folder-btn-${folder.id}" class="text-blue-400 hover:text-blue-300 text-[10px]" title="Scan all games for blunders">üîç Scan All</button>
                            <button onclick="event.stopPropagation(); deleteFolder(${folder.id})" class="text-red-500 hover:text-red-400 text-[10px]">‚úï</button>
                        </div>
                    </div>
                    <div id="folder-${folder.id}" class="border-l-2 border-blue-800/40 ml-3 pl-2 space-y-1 mt-1">
                        ${gamesHtml || '<div class="text-[10px] text-gray-500 italic px-3 py-2">No games in this folder</div>'}
                    </div>
                </div>`;
        }

        function toggleFolderIcon(id) {
            const $contents = $(`#folder-${id}`);
            const $icon = $(`#folder-icon-${id}`);
            $contents.toggleClass('hidden');
            $icon.text($contents.hasClass('hidden') ? 'üìÅ' : 'üìÇ');
        }

        async function scanFolder(folderId) {
            // Get all game IDs in this folder
            const gameIds = [];
            $(`#folder-${folderId} .game-draggable`).each(function () {
                gameIds.push($(this).data('game-id'));
            });
            if (!gameIds.length) return;

            const $btn = $(`#scan-folder-btn-${folderId}`);
            $btn.prop('disabled', true).text('‚è≥ 0/' + gameIds.length);

            for (let i = 0; i < gameIds.length; i++) {
                $btn.text(`‚è≥ ${i + 1}/${gameIds.length}`);
                await new Promise((resolve, reject) => {
                    fetch(`/games/${gameIds[i]}/scan-chunked`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ chunk_size: 10, delay_ms: 500, threshold: 100 })
                    }).then(response => {
                        const reader = response.body.getReader();
                        function read() {
                            reader.read().then(({ done }) => {
                                if (done) { resolve(); return; }
                                read();
                            }).catch(reject);
                        }
                        read();
                    }).catch(reject);
                });
            }

            $btn.text('‚úì Done').removeClass('text-blue-400').addClass('text-green-400');
            setTimeout(() => {
                $btn.text('üîç Scan All').removeClass('text-green-400').addClass('text-blue-400').prop('disabled', false);
            }, 2000);
            loadData();
        }

        function renderGameItem(g, player) {
            const w = g.white || "?", b = g.black || "?";
            const p = player || '';
            const isW = p && w.toLowerCase().includes(p.toLowerCase()), isB = p && b.toLowerCase().includes(p.toLowerCase());
            const nameHtml = g.name ? `<div class="text-[10px] text-purple-300 font-medium">${g.name}</div>` : '';

            return `<div class="bg-gray-750 rounded border border-gray-700 text-sm overflow-hidden game-draggable"
                         draggable="true" data-game-id="${g.id}"
                         ondragstart="handleDragStart(event)" ondragend="handleDragEnd(event)">
                <div class="p-3 flex justify-between items-center cursor-pointer hover:bg-gray-700 transition" onclick="toggleGameExpand(${g.id})">
                    <div class="flex items-center gap-2">
                        <span class="drag-grip text-gray-600 cursor-grab text-[12px] select-none" title="Drag to move">‚†ø</span>
                        <span id="chevron-${g.id}" class="text-gray-500 text-[10px] transform transition-transform">‚ñ∂</span>
                        <div>
                            ${nameHtml}
                            <div class="font-bold text-xs"><span class="${isW ? 'highlight-player' : ''}">${w}</span> vs <span class="${isB ? 'highlight-player' : ''}">${b}</span></div>
                            <div class="text-gray-400 text-[10px]">${g.date} ‚Ä¢ ${g.result}</div>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2">
                        <button onclick="event.stopPropagation(); loadGameMoves(${g.id})" class="text-blue-400 hover:text-blue-300 text-[10px] border border-blue-900/30 px-2 py-1 rounded bg-blue-900/10">LOAD</button>
                        <button onclick="event.stopPropagation(); requestDelete(${g.id}, this)" class="text-red-500 hover:text-red-400 text-[10px] min-w-[40px] text-right">Delete</button>
                    </div>
                </div>
                <div id="game-details-${g.id}" class="hidden border-t border-gray-700 bg-gray-900/50 p-2">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-[10px] font-bold text-gray-500 uppercase">Blunders & Puzzles</span>
                        <div class="flex items-center gap-2">
                            <label class="text-[9px] text-gray-400 flex items-center gap-1">Threshold
                                <input type="number" id="threshold-${g.id}" value="100" min="30" max="500" step="10"
                                    class="bg-gray-700 border border-gray-600 rounded px-1 py-0.5 text-[10px] text-white w-14 text-center focus:outline-none focus:border-blue-500">
                                <span class="text-gray-500">cp</span>
                            </label>
                            <button onclick="scanGame(${g.id})" class="bg-blue-600 hover:bg-blue-500 text-white px-2 py-0.5 rounded text-[10px]">Scan</button>
                        </div>
                    </div>
                    <div id="puzzles-${g.id}" class="space-y-1">
                        <div class="text-[10px] text-gray-500 italic">Click scan to find blunders...</div>
                    </div>
                </div>
            </div>`;
        }

        // --- Drag and Drop ---
        function handleDragStart(e) {
            e.dataTransfer.setData('text/plain', e.currentTarget.dataset.gameId);
            e.dataTransfer.effectAllowed = 'move';
            e.currentTarget.classList.add('dragging');
        }

        function handleDragEnd(e) {
            e.currentTarget.classList.remove('dragging');
            document.querySelectorAll('.folder-drop-zone').forEach(el => el.classList.remove('drag-over'));
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            const zone = e.currentTarget.closest('.folder-drop-zone');
            if (zone) zone.classList.add('drag-over');
        }

        function handleDragLeave(e) {
            const zone = e.currentTarget.closest('.folder-drop-zone');
            // Only remove if we're actually leaving the zone (not entering a child)
            if (zone && !zone.contains(e.relatedTarget)) {
                zone.classList.remove('drag-over');
            }
        }

        function handleDrop(e) {
            e.preventDefault();
            const zone = e.currentTarget.closest('.folder-drop-zone');
            if (zone) zone.classList.remove('drag-over');
            const gameId = parseInt(e.dataTransfer.getData('text/plain'));
            const folderId = zone ? zone.dataset.folderId : '';
            moveGameToFolder(gameId, folderId);
        }

        function createFolder() {
            const name = prompt('Folder name:');
            if (!name || !name.trim()) return;
            $.ajax({
                url: '/folders',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ name: name.trim() }),
                success: loadData
            });
        }

        function renameFolder(id, currentName) {
            const name = prompt('Rename folder:', currentName);
            if (!name || !name.trim()) return;
            $.ajax({
                url: '/folders/' + id,
                type: 'PUT',
                contentType: 'application/json',
                data: JSON.stringify({ name: name.trim() }),
                success: loadData
            });
        }

        function deleteFolder(id) {
            const $modal = $('#delete-folder-modal');
            $modal.removeClass('hidden').find('#delete-folder-name').text(
                $(`#folder-icon-${id}`).parent().find('.text-blue-300').text()
            );
            // Bind buttons
            $('#dfm-cancel').off('click').on('click', () => $modal.addClass('hidden'));
            $('#dfm-keep').off('click').on('click', () => {
                $modal.addClass('hidden');
                $.ajax({ url: '/folders/' + id, type: 'DELETE', success: loadData });
            });
            $('#dfm-delete-all').off('click').on('click', () => {
                $modal.addClass('hidden');
                $.ajax({ url: '/folders/' + id + '?delete_games=true', type: 'DELETE', success: loadData });
            });
        }

        function moveGameToFolder(gameId, folderId) {
            $.ajax({
                url: '/games/' + gameId + '/move',
                type: 'PUT',
                contentType: 'application/json',
                data: JSON.stringify({ folder_id: folderId ? parseInt(folderId) : null }),
                success: loadData
            });
        }

        // --- Lichess Import ---
        function loadLichessSettings() {
            const saved = localStorage.getItem('lichess_settings');
            if (saved) {
                try {
                    const s = JSON.parse(saved);
                    if (s.username) $('#lichess-username').val(s.username);
                    if (s.token) $('#lichess-token').val(s.token);
                } catch (e) { }
            }
        }

        function saveLichessSettings() {
            const settings = {
                username: $('#lichess-username').val().trim(),
                token: $('#lichess-token').val().trim()
            };
            localStorage.setItem('lichess_settings', JSON.stringify(settings));
            showLichessStatus('Settings saved ‚úì', 'text-green-400');
        }

        function getLichessHeaders() {
            const token = $('#lichess-token').val().trim();
            const headers = {};
            if (token) headers['X-Lichess-Token'] = token;
            return headers;
        }

        function showLichessStatus(msg, colorClass) {
            const $s = $('#lichess-status');
            $s.text(msg).removeClass('hidden text-gray-500 text-green-400 text-red-400 text-blue-400').addClass(colorClass || 'text-gray-500');
            if (colorClass === 'text-green-400') {
                setTimeout(() => $s.addClass('hidden'), 2000);
            }
        }

        function browseLichessStudies() {
            const username = $('#lichess-username').val().trim();
            if (!username) {
                showLichessStatus('Enter a Lichess username', 'text-red-400');
                return;
            }

            showLichessStatus('Loading studies...', 'text-blue-400');
            const $list = $('#lichess-studies').empty().removeClass('hidden');

            $.ajax({
                url: '/lichess/studies?username=' + encodeURIComponent(username),
                headers: getLichessHeaders(),
                success: function (studies) {
                    if (!studies.length) {
                        showLichessStatus('No studies found', 'text-gray-500');
                        return;
                    }
                    showLichessStatus(`Found ${studies.length} study(ies)`, 'text-green-400');
                    studies.forEach(s => {
                        const dateStr = s.updatedAt ? new Date(s.updatedAt).toLocaleDateString() : '';
                        $list.append(`
                            <div class="flex justify-between items-center bg-gray-700/30 rounded px-3 py-2 border border-gray-700">
                                <div>
                                    <div class="text-[11px] font-medium text-gray-200">${s.name}</div>
                                    <div class="text-[9px] text-gray-500">${s.chapters} chapter(s) ${dateStr ? '‚Ä¢ ' + dateStr : ''}</div>
                                </div>
                                <button onclick="importLichessStudy('${s.id}', '${s.name.replace(/'/g, "\\'")}', ${s.createdAt || 0})"
                                    id="import-btn-${s.id}"
                                    class="bg-purple-600 hover:bg-purple-500 text-white px-2 py-0.5 rounded text-[10px]">Import</button>
                            </div>
                        `);
                    });
                },
                error: function (xhr) {
                    const err = xhr.responseJSON?.error || 'Failed to load studies';
                    showLichessStatus(err, 'text-red-400');
                }
            });
        }

        function importLichessStudy(studyId, studyName, createdAt) {
            const $btn = $(`#import-btn-${studyId}`);
            $btn.text('Importing...').prop('disabled', true).removeClass('bg-purple-600 hover:bg-purple-500').addClass('bg-gray-600');
            const studyDate = createdAt ? new Date(createdAt).toISOString().split('T')[0] : '';

            $.ajax({
                url: '/lichess/import',
                type: 'POST',
                contentType: 'application/json',
                headers: getLichessHeaders(),
                data: JSON.stringify({ study_id: studyId, study_name: studyName, study_date: studyDate }),
                success: function (res) {
                    $btn.text(`‚úì ${res.imported} games`).removeClass('bg-gray-600').addClass('bg-green-700');
                    loadData();
                },
                error: function (xhr) {
                    const err = xhr.responseJSON?.error || 'Import failed';
                    $btn.text('Error').removeClass('bg-gray-600').addClass('bg-red-700');
                    showLichessStatus(err, 'text-red-400');
                }
            });
        }

        function toggleGameExpand(id) {
            const $details = $(`#game-details-${id}`);
            const $chevron = $(`#chevron-${id}`);
            const isHidden = $details.hasClass('hidden');

            if (isHidden) {
                $details.removeClass('hidden');
                $chevron.css('transform', 'rotate(90deg)');
                loadPuzzles(id);
            } else {
                $details.addClass('hidden');
                $chevron.css('transform', 'rotate(0deg)');
            }
        }

        function loadPuzzles(id) {
            const $container = $(`#puzzles-${id}`);
            $container.html('<div class="text-[10px] text-gray-500 italic">Loading...</div>');
            $.get(`/games/${id}/puzzles`, function (puzzles) {
                if (!puzzles || puzzles.length === 0) {
                    $container.html('<div class="text-[10px] text-gray-500 italic">No puzzles found. Click scan.</div>');
                    return;
                }
                renderPuzzles(id, puzzles);
            });
        }

        function scanGame(id) {
            const $container = $(`#puzzles-${id}`);
            $container.html(`
                <div class="mb-2">
                    <div class="flex justify-between text-[10px] text-blue-400 mb-1">
                        <span id="scan-status-${id}">Scanning...</span>
                        <span id="scan-pct-${id}">0%</span>
                    </div>
                    <div class="w-full bg-gray-700 rounded-full h-2 overflow-hidden">
                        <div id="scan-bar-${id}" class="bg-blue-500 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                </div>
            `);

            // Use fetch + ReadableStream to consume SSE from POST endpoint
            const threshold = parseInt($(`#threshold-${id}`).val()) || 100;
            fetch(`/games/${id}/scan-chunked`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ chunk_size: 10, delay_ms: 500, threshold: threshold })
            }).then(response => {
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';

                function read() {
                    reader.read().then(({ done, value }) => {
                        if (done) {
                            loadPuzzles(id);
                            return;
                        }
                        buffer += decoder.decode(value, { stream: true });
                        // Parse SSE lines
                        const lines = buffer.split('\n');
                        buffer = lines.pop(); // keep incomplete line in buffer
                        lines.forEach(line => {
                            if (line.startsWith('data: ')) {
                                try {
                                    const evt = JSON.parse(line.substring(6));
                                    const pct = Math.round((evt.progress / evt.total) * 100);
                                    $(`#scan-bar-${id}`).css('width', pct + '%');
                                    $(`#scan-pct-${id}`).text(pct + '%');
                                    $(`#scan-status-${id}`).text(
                                        evt.done
                                            ? `Done ‚Äî ${evt.total_puzzles} blunder(s) found`
                                            : `Move ${evt.progress}/${evt.total} (${evt.puzzles_so_far} found)`
                                    );
                                    // Live-update eval chart if this is the selected game
                                    if (evt.evals && id === selectedGameId) {
                                        gameEvals = evt.evals;
                                        drawEvalChart(gameEvals, currentMoveIndex);
                                    }
                                    if (evt.done) {
                                        $(`#scan-bar-${id}`).removeClass('bg-blue-500').addClass('bg-green-500');
                                        setTimeout(() => loadPuzzles(id), 800);
                                    }
                                } catch (e) { /* skip malformed line */ }
                            }
                        });
                        read();
                    });
                }
                read();
            }).catch(() => {
                $container.html('<div class="text-[10px] text-red-400 italic">Scan failed.</div>');
            });
        }

        function renderPuzzles(gameId, puzzles) {
            const $container = $(`#puzzles-${gameId}`).empty();
            puzzles.forEach(p => {
                const diff = Math.abs(p.score_before - p.score_after) / 100;
                const side = p.turn === 'white' ? 'White' : 'Black';
                const $row = $(`<div class="flex justify-between items-center bg-gray-800 p-2 rounded cursor-pointer hover:bg-gray-700 border-l-2 border-red-500" onclick="selectGame(${gameId}, function() { jumpToFen('${p.fen}'); })">
                    <div>
                        <div class="text-[10px] font-bold text-gray-300">Move ${p.move_number} (${side})</div>
                        <div class="text-[9px] text-gray-500">Eval drop: ${diff.toFixed(1)}</div>
                    </div>
                    <div class="text-xs text-gray-400">‚ûú</div>
                </div>`);
                $container.append($row);
            });
        }

        function loadGameMoves(id) {
            selectGame(id);
        }

        function requestDelete(id, btn) {
            const $btn = $(btn);
            if ($btn.text() === 'Delete') {
                $btn.text('Confirm?').addClass('font-bold text-red-300');
                // Auto-revert after 3s
                setTimeout(() => {
                    if (document.body.contains(btn) && $btn.text() === 'Confirm?') {
                        $btn.text('Delete').removeClass('font-bold text-red-300');
                    }
                }, 3000);
            } else {
                // Perform delete
                $btn.text('Deleting...').prop('disabled', true);
                $.ajax({
                    url: '/games/' + id,
                    type: 'DELETE',
                    success: function () {
                        loadData();
                    },
                    error: function (err) {
                        alert('Error deleting game: ' + (err.statusText || 'Unknown error'));
                        loadData();
                    }
                });
            }
        }
        function flipBoard(s) { board.orientation(s); }
        $('#pgn-upload').change(function (e) {
            const fd = new FormData(); fd.append('file', e.target.files[0]);
            $.ajax({ url: '/upload', type: 'POST', data: fd, processData: false, contentType: false, success: loadData });
        });
        $('#player-filter').on('input', loadData);
        board = Chessboard('myBoard', { draggable: true, position: 'start', onDrop: onDrop, moveSpeed: 0, snapSpeed: 0, pieceTheme: '/static/img/chesspieces/svg/{piece}.svg' });
        loadLichessSettings();
        loadData();
        // Initial sizing after board is ready
        setTimeout(() => { resizeBoardArea(); board.resize(); const bh = $('#myBoard').height(); if (bh > 0) $('#eval-bar-v').height(bh); }, 50);

        $(window).resize(function () {
            resizeBoardArea();
            board.resize();
            const bh = $('#myBoard').height();
            if (bh > 0) $('#eval-bar-v').height(bh);
            const svg = document.getElementById('arrow-svg');
            while (svg && svg.firstChild) svg.removeChild(svg.firstChild);
            updateChartIndicator();
        });

        function resizeBoardArea() {
            const headerH = $('header').outerHeight() || 0;
            const viewH = window.innerHeight;
            const availH = viewH - headerH - 8;
            const chartH = $('#eval-chart-wrap').is(':visible') ? 128 : 8;
            const evalBarW = 38;
            const boardAreaW = $('#board-area').width();
            // Board is square: side = min(available height - chart, available width - eval bar - padding)
            const maxBoardSide = Math.min(availH - chartH, boardAreaW - evalBarW - 16);
            const boardSide = Math.max(250, maxBoardSide);
            // Set explicit width on the board wrapper so chessboard.js respects it
            $('#board-wrapper').css('width', boardSide + 'px');
            $('#eval-chart-wrap').css('width', (boardSide + evalBarW) + 'px');
        }

        resizeBoardArea();

        $('#btn-start').click(() => jumpToMove(-1));
        $('#btn-prev').click(() => jumpToMove(currentMoveIndex - 1));
        $('#btn-next').click(() => jumpToMove(currentMoveIndex + 1));
        $('#btn-end').click(() => jumpToMove(gameMoves.length - 1));

        $(document).keydown(function (e) {
            // Only suppress hotkeys when actually typing in a text field
            const focused = document.activeElement;
            const tag = focused ? focused.tagName.toLowerCase() : '';
            const inputType = focused ? (focused.type || '').toLowerCase() : '';
            const isTyping = tag === 'textarea' || (tag === 'input' && ['text', 'search', 'url', 'email', 'password'].includes(inputType));
            if (isTyping) return;

            if (e.which === 37) { e.preventDefault(); focused && focused.blur(); jumpToMove(currentMoveIndex - 1); }
            else if (e.which === 39) { e.preventDefault(); focused && focused.blur(); jumpToMove(currentMoveIndex + 1); }
            else if (e.which === 38) { e.preventDefault(); focused && focused.blur(); jumpToMove(-1); }
            else if (e.which === 40) { e.preventDefault(); focused && focused.blur(); jumpToMove(gameMoves.length - 1); }
            else if (e.which === 70) { e.preventDefault(); focused && focused.blur(); board.flip(); fetchAnalysis(); }
        });
    </script>
    <!-- Delete Folder Modal -->
    <div id="delete-folder-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm"
            onclick="$('#delete-folder-modal').addClass('hidden')"></div>
        <div class="relative bg-gray-800 border border-gray-600 rounded-lg shadow-2xl p-5 w-80 max-w-[90vw]">
            <h3 class="text-sm font-bold text-gray-100 mb-1">Delete Folder</h3>
            <p class="text-[11px] text-gray-400 mb-4">How would you like to delete <span id="delete-folder-name"
                    class="text-blue-300 font-medium"></span>?</p>
            <div class="space-y-2">
                <button id="dfm-keep"
                    class="w-full text-left px-3 py-2 rounded bg-gray-700 hover:bg-gray-600 border border-gray-600 transition">
                    <div class="text-[11px] font-medium text-gray-200">üìÇ Keep games</div>
                    <div class="text-[9px] text-gray-500">Games will be moved to Unfiled</div>
                </button>
                <button id="dfm-delete-all"
                    class="w-full text-left px-3 py-2 rounded bg-red-900/30 hover:bg-red-900/50 border border-red-800/50 transition">
                    <div class="text-[11px] font-medium text-red-300">üóëÔ∏è Delete everything</div>
                    <div class="text-[9px] text-red-400/70">Permanently remove all games and puzzles</div>
                </button>
            </div>
            <button id="dfm-cancel"
                class="w-full mt-3 text-[10px] text-gray-500 hover:text-gray-300 transition">Cancel</button>
        </div>
    </div>
</body>

</html>